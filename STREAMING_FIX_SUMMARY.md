# æµå¼æ¸²æŸ“é—®é¢˜ä¿®å¤æ€»ç»“

## é—®é¢˜æè¿°
ç”¨æˆ·åé¦ˆåœ¨ç”Ÿæˆå›å¤æ—¶åªèƒ½æ˜¾ç¤ºå‰ä¸¤ä¸ªæ±‰å­—ï¼Œç„¶åéœ€è¦é‡æ–°åˆ·æ–°è½¯ä»¶æ‰èƒ½æ˜¾ç¤ºå®Œæ•´å†…å®¹ã€‚ä¾‹å¦‚ï¼š
- å®Œæ•´å†…å®¹ï¼š`æˆ‘æ¥å¸®ä½ æœç´¢ä¸€ä¸‹å…³äº"åˆ¤å¤„å‹‡è€…åˆ‘"çš„ä¿¡æ¯ã€‚ç°åœ¨è®©æˆ‘æœç´¢ä¸€ä¸‹ç›¸å…³çš„å›¾ç‰‡æ¥è·å–å°é¢ï¼šæ ¹æ®æœç´¢ç»“æœï¼Œæˆ‘æ¥ä¸ºä½ è¯¦ç»†ä»‹ç»ã€Šåˆ¤å¤„å‹‡è€…åˆ‘ã€‹è¿™éƒ¨ç•ªå‰§ï¼š`
- å®é™…æ˜¾ç¤ºï¼š`æˆ‘æ¥` ç„¶åå¡ä½ï¼Œåˆ·æ–°åæ˜¾ç¤ºï¼š`ç°åœ¨æ ¹æ®`

## é—®é¢˜åˆ†æ
è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„æµå¼æ¸²æŸ“è¢«è‡ªåŠ¨å¢å¼ºé€»è¾‘å¹²æ‰°çš„é—®é¢˜ï¼š

1. **æµå¼æ£€æµ‹ä¸å‡†ç¡®**ï¼šæµå¼ç»“æŸæ£€æµ‹æ—¶é—´å¤ªçŸ­ï¼ˆ1ç§’ï¼‰ï¼Œå¯èƒ½åœ¨æµå¼è¿‡ç¨‹ä¸­å°±è§¦å‘è‡ªåŠ¨å¢å¼º
2. **å†…å®¹æ›¿æ¢å†²çª**ï¼šè‡ªåŠ¨å¢å¼ºè¿‡ç¨‹ä¸­æ›¿æ¢äº†æ­£åœ¨æµå¼æ›´æ–°çš„å†…å®¹
3. **çŠ¶æ€ç®¡ç†æ··ä¹±**ï¼šæµå¼çŠ¶æ€å’Œå¢å¼ºçŠ¶æ€æ²¡æœ‰æ­£ç¡®åè°ƒ

## ä¿®å¤å†…å®¹

### 1. æ”¹è¿›æµå¼æ£€æµ‹é€»è¾‘ (`src/components/EnhancedMarkdownMessage.tsx`)

**ä¿®æ”¹å‰**ï¼š
```typescript
const streamingTimer = setTimeout(() => {
  setIsStreaming(false);
}, 1000); // 1ç§’å¤ªçŸ­
```

**ä¿®æ”¹å**ï¼š
```typescript
const streamingTimer = setTimeout(() => {
  console.log(`[EnhancedMarkdownMessage] Streaming ended for content: "${content.substring(0, 50)}..."`);
  setIsStreaming(false);
}, 2000); // å¢åŠ åˆ°2ç§’ï¼Œç¡®ä¿æµå¼å®Œå…¨ç»“æŸ
```

### 2. å¢å¼ºæµå¼ä¿æŠ¤æœºåˆ¶

**æ–°å¢å¤šé‡ä¿æŠ¤**ï¼š
```typescript
// å¦‚æœæ­£åœ¨æµå¼æ›´æ–°ï¼Œä¸æ‰§è¡Œè‡ªåŠ¨å¢å¼º
if (isStreaming) {
  console.log(`[EnhancedMarkdownMessage] Skipping auto-enhancement during streaming`);
  return;
}

// ç¡®ä¿å†…å®¹è¶³å¤Ÿå®Œæ•´æ‰è¿›è¡Œå¢å¼ºï¼ˆé¿å…å¯¹ä¸å®Œæ•´çš„æµå¼å†…å®¹å¢å¼ºï¼‰
if (content.length < 50) {
  console.log(`[EnhancedMarkdownMessage] Content too short for enhancement: ${content.length} chars`);
  return;
}
```

### 3. ä¿®å¤å†…å®¹æ˜¾ç¤ºé€»è¾‘

**å…³é”®ä¿®å¤**ï¼šåœ¨æµå¼è¿‡ç¨‹ä¸­å§‹ç»ˆä½¿ç”¨åŸå§‹å†…å®¹
```typescript
// å…³é”®ä¿®å¤ï¼šåœ¨æµå¼è¿‡ç¨‹ä¸­å§‹ç»ˆä½¿ç”¨åŸå§‹å†…å®¹ï¼Œé¿å…æ˜¾ç¤ºé—®é¢˜
const contentToUse = isStreaming ? content : (enhancedContent !== content ? enhancedContent : content);

console.log(`[EnhancedMarkdownMessage] Content selection: streaming=${isStreaming}, using ${contentToUse === content ? 'original' : 'enhanced'} content`);
```

### 4. æµå¼æœŸé—´éšè—è‡ªåŠ¨å¢å¼ºå†…å®¹

**å›¾ç‰‡å’Œå¼•ç”¨ä¿æŠ¤**ï¼š
```typescript
// åœ¨æµå¼è¿‡ç¨‹ä¸­ä¸æ˜¾ç¤ºè‡ªåŠ¨å¢å¼ºçš„å›¾ç‰‡ï¼Œé¿å…å¹²æ‰°
const imagesToUse = isStreaming ? [] : autoEnhancedImages;

// åœ¨æµå¼è¿‡ç¨‹ä¸­ä¸æ˜¾ç¤ºè‡ªåŠ¨å¢å¼ºçš„å¼•ç”¨ï¼Œé¿å…å¹²æ‰°
const citationsToUse = isStreaming ? [] : autoEnhancedCitations;
```

### 5. å¢åŠ è¯¦ç»†è°ƒè¯•æ—¥å¿—

åœ¨å…³é”®ä½ç½®æ·»åŠ äº†è°ƒè¯•æ—¥å¿—ï¼š
- æµå¼çŠ¶æ€å˜åŒ–
- å†…å®¹é€‰æ‹©é€»è¾‘
- è‡ªåŠ¨å¢å¼ºå†³ç­–è¿‡ç¨‹
- å†…å®¹é•¿åº¦æ£€æŸ¥

## ä¿®å¤æ•ˆæœ

### âœ… ç°åœ¨çš„è¡Œä¸ºï¼š
1. **æµå¼æ¸²æŸ“æ­£å¸¸**ï¼šAIå›å¤ä¼šé€å­—æ˜¾ç¤ºï¼Œä¸ä¼šå¡åœ¨å‰ä¸¤ä¸ªå­—
2. **è‡ªåŠ¨å¢å¼ºå»¶è¿Ÿ**ï¼šç­‰å¾…æµå¼å®Œå…¨ç»“æŸåå†æ‰§è¡Œè‡ªåŠ¨å¢å¼º
3. **å†…å®¹æ˜¾ç¤ºç¨³å®š**ï¼šæµå¼è¿‡ç¨‹ä¸­å§‹ç»ˆæ˜¾ç¤ºåŸå§‹å†…å®¹ï¼Œä¸ä¼šè¢«å¢å¼ºå†…å®¹å¹²æ‰°
4. **çŠ¶æ€åè°ƒè‰¯å¥½**ï¼šæµå¼çŠ¶æ€å’Œå¢å¼ºçŠ¶æ€æ­£ç¡®åè°ƒï¼Œäº’ä¸å¹²æ‰°

### ğŸ”§ æŠ€æœ¯æ”¹è¿›ï¼š
- æ›´å‡†ç¡®çš„æµå¼æ£€æµ‹ï¼ˆ2ç§’å»¶è¿Ÿï¼‰
- å¤šé‡ä¿æŠ¤æœºåˆ¶é˜²æ­¢å¹²æ‰°
- æ™ºèƒ½å†…å®¹é€‰æ‹©é€»è¾‘
- å®Œå–„çš„è°ƒè¯•æ—¥å¿—ç³»ç»Ÿ

## æµ‹è¯•å»ºè®®

1. **åŸºæœ¬æµå¼æµ‹è¯•**ï¼š
   - é—®ä¸€ä¸ªéœ€è¦é•¿å›å¤çš„é—®é¢˜
   - è§‚å¯ŸAIå›å¤æ˜¯å¦èƒ½å®Œæ•´é€å­—æ˜¾ç¤º
   - ç¡®è®¤ä¸ä¼šå¡åœ¨å‰å‡ ä¸ªå­—

2. **è‡ªåŠ¨å¢å¼ºæµ‹è¯•**ï¼š
   - ç­‰å¾…æµå¼å®Œæˆåï¼Œæ£€æŸ¥æ˜¯å¦æ­£ç¡®æ˜¾ç¤ºå›¾ç‰‡å’Œå¼•ç”¨
   - ç¡®è®¤å¢å¼ºå†…å®¹ä¸ä¼šåœ¨æµå¼è¿‡ç¨‹ä¸­å‡ºç°

3. **è¾¹ç•Œæƒ…å†µæµ‹è¯•**ï¼š
   - æµ‹è¯•å¾ˆçŸ­çš„å›å¤ï¼ˆ<50å­—ç¬¦ï¼‰
   - æµ‹è¯•å¾ˆé•¿çš„å›å¤
   - æµ‹è¯•åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„å›å¤

## æ„å»ºçŠ¶æ€
âœ… æ„å»ºæˆåŠŸï¼Œæ— é”™è¯¯å’Œè­¦å‘Š

## ç›¸å…³æ–‡ä»¶
- `src/components/EnhancedMarkdownMessage.tsx` - ä¸»è¦ä¿®å¤æ–‡ä»¶
- `src/services/auto-enhancement-service.ts` - å¼•ç”¨ç”Ÿæˆé€»è¾‘
- `src/services/citation-service.ts` - å¼•ç”¨å¤„ç†é€»è¾‘